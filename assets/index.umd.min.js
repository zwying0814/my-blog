!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Marku={})}(this,function(t){"use strict";class e{static findCounterElements(){return"undefined"==typeof document?[]:document.querySelectorAll("[marku-get-count]")}static findSetCounterElements(){return"undefined"==typeof document?[]:document.querySelectorAll("[marku-set-count]")}}class s{static parseIncrement(t){const e=t.getAttribute("marku-inc");if(null!==e){const t=parseInt(e,10);return isNaN(t)?1:t}return 1}}class n{constructor(){this.config={siteId:"",apiBaseUrl:""}}static getInstance(){return n.instance||(n.instance=new n),n.instance}init(t,e){this.config="string"==typeof t?{siteId:t,apiBaseUrl:e||""}:{...this.config,...t}}getConfig(){return{...this.config}}getSiteId(){return this.config.siteId}getApiBaseUrl(){return this.config.apiBaseUrl}validate(){const t=[];return this.config.siteId||t.push("siteId is required"),this.config.apiBaseUrl||t.push("apiBaseUrl is required"),{valid:0===t.length,errors:t}}}const r=n.getInstance();class i{static async fetchCountersBatch(t){const e=new Map;if(0===t.length)return e;const s=r.getConfig();if(!s.apiBaseUrl)return t.forEach(t=>{e.set(t,null)}),e;try{const n=new URL("/api/count/batch",s.apiBaseUrl),r={siteId:s.siteId,keys:t},i=new AbortController,a=setTimeout(()=>i.abort(),1e4),o=await fetch(n.toString(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),signal:i.signal});if(clearTimeout(a),!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const u=await o.json();200===u.code&&u.data?(u.data.forEach(t=>{e.set(t.key,t.num||0)}),t.forEach(t=>{e.has(t)||e.set(t,0)})):t.forEach(t=>{e.set(t,null)})}catch(s){t.forEach(t=>{e.set(t,null)})}return e}static async submitCountersBatch(t){if(0===t.length)return!0;const e=r.getConfig();if(!e.apiBaseUrl)return!1;if(!e.siteId)return!1;try{const s=new URL("/api/increment/batch",e.apiBaseUrl),n={siteId:e.siteId,counters:t},r=new AbortController,i=setTimeout(()=>r.abort(),1e4),a=await fetch(s.toString(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n),signal:r.signal});if(clearTimeout(i),!a.ok)throw new Error(`HTTP error! status: ${a.status}`);return 200===(await a.json()).code}catch(t){return!1}}}class a{constructor(){this.initialized=!1}init(t,e){this.initialized||(this.initialized=!0,r.init(t,e),this.loadCounters(),this.processSetCounters())}async loadCounters(){const t=e.findCounterElements();if(0===t.length)return;const s=new Map,n=[];Array.from(t).forEach(t=>{const e=t.getAttribute("marku-get-count");e&&(s.has(e)||(s.set(e,[]),n.push(e)),s.get(e).push(t),t.classList.add("marku-loading"))});const r=await i.fetchCountersBatch(n);s.forEach((t,e)=>{const s=r.get(e);t.forEach(t=>{if(null!=s){if(t.textContent=s.toString(),t.classList.remove("marku-loading"),t.classList.add("marku-loaded"),"undefined"!=typeof CustomEvent){const n=new CustomEvent("marku:counter-loaded",{detail:{key:e,count:s}});t.dispatchEvent(n)}}else if(t.classList.remove("marku-loading"),t.classList.add("marku-error"),"undefined"!=typeof CustomEvent){const s=new CustomEvent("marku:counter-error",{detail:{key:e}});t.dispatchEvent(s)}})})}async processSetCounters(){const t=e.findSetCounterElements(),n=Array.from(t).filter(t=>!t.classList.contains("marku-submitted")&&!t.classList.contains("marku-processing"));if(0===n.length)return;const r=[];n.forEach(t=>{const e=t.getAttribute("marku-set-count");if(!e)return;const n=s.parseIncrement(t);r.push({key:e,increment:n}),t.classList.add("marku-processing")});const i=await this.submitCountersBatch(r);n.forEach(t=>{if(t.classList.remove("marku-processing"),i){if(t.classList.add("marku-submitted"),"undefined"!=typeof CustomEvent){const e=t.getAttribute("marku-set-count"),n=s.parseIncrement(t),r=new CustomEvent("marku:counter-submitted",{detail:{key:e,increment:n}});t.dispatchEvent(r)}}else if(t.classList.add("marku-submit-error"),"undefined"!=typeof CustomEvent){const e=t.getAttribute("marku-set-count"),s=new CustomEvent("marku:counter-submit-error",{detail:{key:e}});t.dispatchEvent(s)}})}async submitCountersBatch(t){return await i.submitCountersBatch(t)}reload(){this.initialized&&(this.clearElementStates(),this.loadCounters(),this.processSetCounters())}clearElementStates(){const t=e.findCounterElements();Array.from(t).forEach(t=>{t.classList.remove("marku-loaded","marku-loading","marku-error")});const s=e.findSetCounterElements();Array.from(s).forEach(t=>{t.classList.remove("marku-submitted","marku-processing","marku-submit-error")})}}const o=new a,u=(t,e)=>o.init(t,e),c=()=>o.reload(),l="1.0.0",d="Marku";var f={VERSION:l,LIBRARY_NAME:d,MarkuCounter:a,init:u,defaultCounter:o,reload:c,Utils:s};t.LIBRARY_NAME=d,t.MarkuCounter=a,t.Utils=s,t.VERSION=l,t.default=f,t.defaultCounter=o,t.init=u,t.reload=c,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=index.umd.min.js.map
